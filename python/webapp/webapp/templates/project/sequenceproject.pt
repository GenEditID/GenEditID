<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n">

<style>
div#data
{
    display: none;
}
</style>

<div id="data">
    <span id="labidspan" tal:content="lab_id"></span>
    <span id="researcheridspan" tal:content="researcher_id"></span>
    <span id="projectidspan" tal:content="project_id"></span>
    <span id="jsonmap" tal:content="jsonmap"></span>
</div>

<div metal:use-macro="load: ../layout.pt">
  <div metal:fill-slot="content">
    <div class="content">
      <div class="container-fluid">
        <h1>Genome Editing Core</h1>
        <h2>Submit for Sequencing: ${geproject.geid}</h2>
        <hr />
        <p>
            <a href="${request.route_url('home')}">Back to projects list</a> |
            <a href="${request.route_url('project_view', projectid=geproject.id)}">Back to view project ${geproject.geid}</a>
        </p>
        <hr />

        <form id="submit_sequencing_form" method="post" action="${request.route_url('project_sequence', projectid=geproject.id)}">
            <p>
                Who is the submission for?
            </p>
            <p>
                Lab/group:
                <select id="lab_select" name="lab_id"></select>
            </p>
            <p>
                Researcher:
                <select id="researcher_select" name="researcher_id" disabled="disabled"></select>
            </p>
            <p>
                Submit to project:
                <select id="project_select" name="project_id" disabled="disabled"></select>
            </p>
            <input id="submitbutton" type="submit" name="go_sequence" value="Submit to Clarity" disabled="disabled"></input>
        </form>
        <hr />
        <p>
            <a href="${request.route_url('home')}">Back to projects list</a> |
            <a href="${request.route_url('project_view', projectid=geproject.id)}">Back to view project ${geproject.geid}</a>
        </p>
        <hr />

      </div>
    </div>
  </div>
</div>
<script>
var infomap;

labselected = function()
{
    var labselect = $('#lab_select');
    var researcherselect = $('#researcher_select');
    var projectselect = $('#project_select');

    researcherselect.empty();
    projectselect.empty();
    $('#submitbutton').prop('disabled', true);

    var labid = labselect.find(":selected").val();
    if (!!labid)
    {
        var lab = infomap[labid];

        var researcherarray = $.map(lab.researchers, function(v) { return v; });
        researcherarray.sort(
            function(a, b) {
                return a.name.localeCompare(b.name);
            });
        
        for (var l = 0; l < researcherarray.length; l++)
        {
            var researcher = researcherarray[l];
            researcherselect.append($("<option/>").val(researcher.id).text(researcher.name));
        }
    }
    
    researcherselect.prop('disabled', false);
    projectselect.prop('disabled', 'disabled');
}

researcherselected = function()
{
    var labselect = $('#lab_select');
    var researcherselect = $('#researcher_select');
    var projectselect = $('#project_select');

    projectselect.empty();
    $('#submitbutton').prop('disabled', true);

    var labid = labselect.find(":selected").val();
    var researcherid = researcherselect.find(":selected").val();
    if (!!labid && !!researcherid)
    {
        var lab = infomap[labid];
        var researcher = lab.researchers[researcherid];

        var projectarray = $.map(researcher.projects, function(v) { return v; });
        projectarray.sort(
            function(a, b) {
                return a.name.localeCompare(b.name);
            });
        
        for (var l = 0; l < projectarray.length; l++)
        {
            var project = projectarray[l];
            projectselect.append($("<option/>").val(project.id).text(project.name));
        }
    }
    
    projectselect.prop('disabled', false);
}

projectselected = function()
{
    var projectselect = $('#project_select');

    var projectid = projectselect.find(":selected").val();

    var prop = !!projectid ? false : 'disabled';
    $('#submitbutton').prop('disabled', prop);
}

submitting = function()
{
    alert("Submitting.");
    return true;
}

$(document).ready(function() {
    infomap = JSON.parse($('#jsonmap').text());

    var labselect = $('#lab_select');
    var researcherselect = $('#researcher_select');
    var projectselect = $('#project_select');

    var labarray = $.map(infomap, function(v) { return v; });
    labarray.sort(
        function(a, b) {
            return a.name.localeCompare(b.name);
        });
    
    for (var l = 0; l < labarray.length; l++)
    {
        var lab = labarray[l];
        labselect.append($("<option/>").val(lab.id).text(lab.name));
    }

    labselect.change(labselected);
    researcherselect.change(researcherselected);
    projectselect.change(projectselected);
    $('#submit_sequencing_form').submit(submitting);

    var selectedlab = $('#labidspan').text();
    if (!!selectedlab)
    {
        labselect.val(selectedlab).prop('selected', true).change();

        var selectedresearcher = $('#researcheridspan').text();
        if (!!selectedresearcher)
        {
            researcherselect.val(selectedresearcher).prop('selected', true).change();

            var selectedproject = $('#projectidspan').text();
            if (!!selectedresearcher)
            {
                projectselect.val(selectedproject).prop('selected', true).change();
            }
        }
    }
});
</script>
