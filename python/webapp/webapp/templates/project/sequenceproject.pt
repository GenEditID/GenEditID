<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n">

<div metal:use-macro="load: ../layout.pt">
  <div metal:fill-slot="content">
    <div class="content">
      <div class="container-fluid">
        <h1>Genome Editing Core</h1>
        <h2>Submit for Sequencing: ${geproject.geid}</h2>
        <hr />
        <p>
            <a href="${request.route_url('home')}">Back to projects list</a> |
            <a href="${request.route_url('project_view', projectid=geproject.id)}">Back to view project ${geproject.geid}</a>
        </p>
        <hr />

        <span id="jsonmap" tal:content="jsonmap" style="display:none;"></span>

        <form id="submit_sequencing_form" method="post" action="${request.route_url('project_sequence', projectid=geproject.id)}">
            <p>
                Who is the submission for?
            </p>
            <p>
                Lab/group:
                <select id="lab_select" name="lab_id"></select> 
            </p>
            <p>
                Researcher:
                <select id="researcher_select" name="researcher_id"></select> 
            </p>
            <p>
                Submit to project:
                <select id="project_select" name="researcher_id"></select> 
            </p>
            <input id="submitbutton" type="submit" name="submit_researcher" value="Submit to Clarity" disabled="disabled"></input>
        </form>
        <hr />
        <p>
            <a href="${request.route_url('home')}">Back to projects list</a> |
            <a href="${request.route_url('project_view', projectid=geproject.id)}">Back to view project ${geproject.geid}</a>
        </p>
        <hr />

      </div>
    </div>
  </div>
</div>
<script>
var infomap;

labselected = function()
{
    var labselect = $('#lab_select');
    var researcherselect = $('#researcher_select');
    var projectselect = $('#project_select');

    researcherselect.empty();
    projectselect.empty();
    $('#submitbutton').prop('disabled', true);
    
    var labid = labselect.find(":selected").val();
    if (!!labid)
    {
        var lab = infomap[labid];
        
        for (property in lab.researchers)
        {
            var researcher = lab.researchers[property];
            researcherselect.append($("<option/>").val(researcher.id).text(researcher.name));
        }
    }
}

researcherselected = function()
{
    var labselect = $('#lab_select');
    var researcherselect = $('#researcher_select');
    var projectselect = $('#project_select');
    
    projectselect.empty();
    $('#submitbutton').prop('disabled', true);
    
    var labid = labselect.find(":selected").val();
    var researcherid = researcherselect.find(":selected").val();
    if (!!labid && !!researcherid)
    {
    	var lab = infomap[labid];
    	var researcher = lab.researchers[researcherid];
    
        for (property in researcher.projects)
        {
            var project = researcher.projects[property];
            projectselect.append($("<option/>").val(project.id).text(project.name));
        }
    }
}

projectselected = function()
{
    var projectselect = $('#project_select');

    var projectid = projectselect.find(":selected").val();
    
    $('#submitbutton').prop('disabled', !projectid);
}

submitting = function()
{
    alert("Submitting.");
    return false;
}

$(document).ready(function() {
    infomap = JSON.parse($('#jsonmap').text());
    
    var labselect = $('#lab_select');
    var researcherselect = $('#researcher_select');
    var projectselect = $('#project_select');

    for (property in infomap)
    {
        if (infomap.hasOwnProperty(property))
        {
            var lab = infomap[property];
            labselect.append($("<option/>").val(lab.id).text(lab.name));
        }
    }
    
    labselect.change(labselected);
    researcherselect.change(researcherselected);
    projectselect.change(projectselected);
    $('#submit_sequencing_form').submit(submitting);
});
</script>
